{% extends "visualize/base.html" %}

{% load staticfiles %}

{% block head_block %}
<!-- production
<script type="text/javascript" src="../js/plupload.full.min.js"></script>
-->

<!-- debug -->
<script type="text/javascript" src="{% static 'plupload/js/moxie.js' %}"></script>
<script type="text/javascript" src="{% static 'plupload/js/plupload.dev.js' %}"></script>
{% endblock %}


{% block body_block %}
  <div>
    <h1>Upload Files</h1>
  </div>

  <div id="upload-progress"></div>
  <ul>  
    <div id="filelist"></div>
  </ul>

  <form id="upload-form" method="POST" action="">
    {% csrf_token %}
    <label for="album-name">Album Name</label>
    <input id="album-name" type="text">
    <button id="file-select">Select Images</button>
    <button id="upload-btn" type="submit" value="Upload">Start Upload</button>
  </form>

  <pre id="console">
    <div id="requirments">Your browser doesn't have Flash, Silverlight, or HTML5 support.</div>
  </pre>

<!-- Plupload js only works in a script tag -->
  <script type="text/javascript">
    function start_upload(up, name) {
      if (name.length === 0) {
        display_error("Please enter an Album Name");
        return;
      }

      // Ajax call to create album, display error if album name is not unique
      $.ajax({
        url: "{% url 'create_album' %}",
        data: {
          album_name: name,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        type: "POST",
        dataType: "json",

        success: function(json) {
          if (json['success']) {            
            // Start plupload upload of images
            up.start();
          } else {
            display_error(json['error_message']);
            return;
          }
        },

        error: function(xhr, status, errorThrown) {
          display_error("Ajax error");
          console.log(errorThrown);
          return;
        }
      });
    }


    function display_error(message) {
      document.getElementById('console').appendChild(document.createTextNode("\nError: " + message));
    }


    var uploader = new plupload.Uploader({
      // Plupload settings
      runtimes: 'html5,flash,silverlight',
      browse_button: 'file-select',
      url : "{% url 'upload_image' %}",
      file_data_name:'image',
      flash_swf_url: "{% static 'plupload/js/Moxie.swf' %}",
      silverlight_xap_url: "{% static 'plupload/js/Moxie.xap' %}",
      
      // Jpgs under 10mb only
      filters: {
        max_file_size: '10mb',
        mime_types: [
          {title: "Image files", extensions: "jpg, jpeg"},
        ]
      },

      // Plupload custom callback functions
      init: {
        PostInit: function(up) {
          document.getElementById('requirments').innerHTML = '';

          document.getElementById('upload-btn').onclick = function() {

            // Verify there are files
            if (up.total.queued > 0) {              
              up.settings.album_name = $.trim(document.getElementById("album-name").value);
              album_response = start_upload(uploader, up.settings.album_name);
            } else {
              display_error("Please select at lease one file to upload.")
            }
            
            // start_upload only returns on an error, otherwise starts the upload
            return false;
          };
        },
        FilesAdded: function(up, files) {
          plupload.each(files, function(file) {
            document.getElementById('filelist').innerHTML += '<li id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ')<span class="file-upload-progress"</span></li>';
          });
          document.getElementById("file-select").disabled = true;
          up.settings.total_files = up.total.queued;
        },

        // Add csrf token required by Django and the other form elements to request
        BeforeUpload: function(up, file) {
          document.getElementById("upload-btn").disabled = true;
          up.settings.multipart_params = {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            album_name: up.settings.album_name
          };
        },

        UploadProgress: function(up, file) {
          document.getElementById(file.id).getElementsByClassName('file-upload-progress')[0].innerHTML = " " + file.percent + "%";
        },
        FileUploaded: function(up, file) {
          document.getElementById('upload-progress').innerHTML = 
          "<span>" + up.total.uploaded + "/" + up.settings.total_files + " - " + up.total.percent + "%</span>"
        },
        Error: function(up, err) {
          document.getElementById('console').appendChild(document.createTextNode("\nError #" + err.code + ": " + err.message));
        }
      }
  });


  uploader.init();
  </script>
{% endblock %}
