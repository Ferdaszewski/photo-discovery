{% extends "visualize/base.html" %}

{% load staticfiles %}

{% block head_block %}
<!-- production
<script type="text/javascript" src="../js/plupload.full.min.js"></script>
-->

<!-- debug -->
<script type="text/javascript" src="{% static 'plupload/js/moxie.js' %}"></script>
<script type="text/javascript" src="{% static 'plupload/js/plupload.dev.js' %}"></script>
{% endblock %}


{% block body_block %}
  <div>
    <h1>Upload Files</h1>
  </div>

  <div id="upload-progress"></div>
  <ul>  
    <div id="filelist"></div>
  </ul>

  <form id="upload-form" method="POST" action="">
    {% csrf_token %}
    <label for="album-name">Album Name</label>
    <input id="album-name" type="text">
    <button id="file-select">Select Images</button>
    <button id="upload-btn" type="submit" value="Upload">Start Upload</button>
  </form>

  <pre id="console">
    <div id="requirments">Your browser doesn't have Flash, Silverlight, or HTML5 support.</div>
  </pre>

<!-- Plupload js only works in a script tag -->
  <script type="text/javascript">    
    var uploader = new plupload.Uploader({

      // Plupload settings
      runtimes: 'html5,flash,silverlight',
      browse_button: 'file-select',
      url : "{% url 'upload_image' %}",
      file_data_name:'image',
      flash_swf_url: "{% static 'plupload/js/Moxie.swf' %}",
      silverlight_xap_url: "{% static 'plupload/js/Moxie.xap' %}",
      
      // Jpgs under 10mb only
      filters: {
        max_file_size: '10mb',
        mime_types: [
          {title: "Image files", extensions: "jpg, jpeg"},
        ]
      },

      // Plupload custom callback functions
      init: {
        PostInit: function() {
          document.getElementById('requirments').innerHTML = '';
          document.getElementById('upload-btn').onclick = function() {
            uploader.start();
            return false;
          };
        },
        FilesAdded: function(up, files) {
          plupload.each(files, function(file) {
            document.getElementById('filelist').innerHTML += '<li id="' + file.id + '">' + file.name + ' (' + plupload.formatSize(file.size) + ')<span class="file-upload-progress"</span></li>';
          });
          document.getElementById("file-select").disabled = true;
          up.settings.total_files = up.total.queued;
        },

        // Add csrf token required by Django and the other form elements to request
        BeforeUpload: function(up, file) {
          document.getElementById("upload-btn").disabled = true;
          up.settings.multipart_params = {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            album_name: document.getElementById("album-name").value
          };
        },

        UploadProgress: function(up, file) {
          document.getElementById(file.id).getElementsByClassName('file-upload-progress')[0].innerHTML = " " + file.percent + "%";
        },
        FileUploaded: function(up, file) {
          document.getElementById('upload-progress').innerHTML = 
          "<span>" + up.total.uploaded + "/" + up.settings.total_files + " - " + up.total.percent + "%</span>"
        },
        Error: function(up, err) {
          document.getElementById('console').appendChild(document.createTextNode("\nError #" + err.code + ": " + err.message));
        }
      }
  });

  function get_album_name() {
    return document.getElementById('album-name').value
  };

  uploader.init();
  </script>
{% endblock %}
